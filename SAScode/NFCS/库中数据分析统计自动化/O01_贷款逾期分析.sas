
%MACRO OVERDUE_ANALYSIS(STAT_DT);
/*T-1月逾期情况按贷款类型*/
PROC SQL;
	CREATE TABLE LOAN_OVERDUE_N AS SELECT
		SLOANTYPE 
		,SUM(ICREDITLIMIT) AS LOAN_TOTAL
		,SUM(CASE WHEN SACCOUNT^=''  THEN 1 ELSE 0 END) AS LOAN_CNT
		,SUM(IAMOUNTPASTDUE) AS DUE_TOTAL
		,SUM(CASE WHEN IAMOUNTPASTDUE>0 THEN 1 ELSE 0 END) AS DUE_TOTAL_CNT
		,SUM(IAMOUNTPASTDUE30) AS DUE_30
		,SUM(CASE WHEN IAMOUNTPASTDUE30>0 THEN 1 ELSE 0 END) AS DUE_30_CNT
		,SUM(IAMOUNTPASTDUE60) AS DUE_60
		,SUM(CASE WHEN IAMOUNTPASTDUE60>0 THEN 1 ELSE 0 END) AS DUE_60_CNT
		,SUM(IAMOUNTPASTDUE90) AS DUE_90
		,SUM(CASE WHEN IAMOUNTPASTDUE90>0 THEN 1 ELSE 0 END) AS DUE_90_CNT
		,SUM(IAMOUNTPASTDUE180) AS DUE_180
		,SUM(CASE WHEN IAMOUNTPASTDUE180>0 THEN 1 ELSE 0 END) AS DUE_180_CNT
	FROM Sino_loan_n2
	GROUP BY SLOANTYPE;
QUIT;
/*T-2月逾期情况按贷款类型*/
PROC SQL;
	CREATE TABLE LOAN_OVERDUE_O AS SELECT
		SLOANTYPE 
		,SUM(ICREDITLIMIT) AS LOAN_TOTAL
		,SUM(CASE WHEN SACCOUNT ^= '' THEN 1 ELSE 0 END) AS LOAN_CNT
		,SUM(IAMOUNTPASTDUE) AS DUE_TOTAL
		,SUM(CASE WHEN IAMOUNTPASTDUE>0 THEN 1 ELSE 0 END) AS DUE_TOTAL_CNT
		,SUM(IAMOUNTPASTDUE30) AS DUE_30
		,SUM(CASE WHEN IAMOUNTPASTDUE30>0 THEN 1 ELSE 0 END) AS DUE_30_CNT
		,SUM(IAMOUNTPASTDUE60) AS DUE_60
		,SUM(CASE WHEN IAMOUNTPASTDUE60>0 THEN 1 ELSE 0 END) AS DUE_60_CNT
		,SUM(IAMOUNTPASTDUE90) AS DUE_90
		,SUM(CASE WHEN IAMOUNTPASTDUE90>0 THEN 1 ELSE 0 END) AS DUE_90_CNT
		,SUM(IAMOUNTPASTDUE180) AS DUE_180
		,SUM(CASE WHEN IAMOUNTPASTDUE180>0 THEN 1 ELSE 0 END) AS DUE_180_CNT
	FROM Sino_loan_O2
	GROUP BY SLOANTYPE;
QUIT;

PROC SQL NOPRINT;
	CREATE TABLE O01 AS SELECT
		PUT(T1.SLOANTYPE,$LOAN_LEVEL.) AS LOAN_TYPE  LABEL="贷款类型"
		,T1.DUE_TOTAL_CNT AS DUE_CNT_N LABEL="库中当月逾期账户数"
		,T2.DUE_TOTAL_CNT AS DUE_CNT_O LABEL="库中上月逾期账户数"
		,PUT((T1.DUE_TOTAL_CNT-T2.DUE_TOTAL_CNT)/T2.DUE_TOTAL_CNT,PERCENTN8.2) AS NADD_DUECNT LABEL="库中逾期账户数环比增长率"
		,round(T1.DUE_TOTAL/10000,1) AS DUE_AMT_N LABEL="当月逾期金额"
		,round(T2.DUE_TOTAL/10000,1) AS DUE_AMT_O LABEL="上月逾期金额"
		,PUT((T1.DUE_TOTAL-T2.DUE_TOTAL)/T2.DUE_TOTAL,PERCENTN8.2) AS NADD_DUEAMT LABEL="逾期金额环比增长率"
		,ROUND((T1.DUE_TOTAL/10000)/T1.DUE_TOTAL_CNT,0.01) AS AVG_DUEAMT_N LABEL="当月平均逾期金额"
		,ROUND((T2.DUE_TOTAL/10000)/T2.DUE_TOTAL_CNT,0.01) AS AVG_DUEAMT_O LABEL="上月平均逾期金额"
	FROM LOAN_OVERDUE_N AS T1
	LEFT JOIN LOAN_OVERDUE_O AS T2
	ON T1.SLOANTYPE=T2.SLOANTYPE;
QUIT;
 

PROC SQL NOPRINT;
	CREATE TABLE O02 AS SELECT
		PUT(T1.SLOANTYPE,$LOAN_LEVEL.) AS LOAN_TYPE  LABEL="贷款类型"
		,PUT(T1.DUE_TOTAL/T1.LOAN_TOTAL,PERCENTN8.2) AS DUE_N LABEL="库中当月逾期率"
		,PUT(T2.DUE_TOTAL/T2.LOAN_TOTAL,PERCENTN8.2) AS DUE_O LABEL="库中上月逾期率"
		,PUT((T1.DUE_TOTAL/T1.LOAN_TOTAL)/(T2.DUE_TOTAL/T2.LOAN_TOTAL)-1,PERCENTN8.2) AS NADD_DUEAMT LABEL="逾期率的环比变化率"
	FROM LOAN_OVERDUE_N AS T1
	LEFT JOIN LOAN_OVERDUE_O AS T2
	ON T1.SLOANTYPE=T2.SLOANTYPE;
QUIT;
 
PROC SQL NOPRINT;
	CREATE TABLE O03 AS SELECT
		PUT(T1.SLOANTYPE,$LOAN_LEVEL.) AS LOAN_TYPE  LABEL="贷款类型"
		,T1.DUE_30_CNT AS DUE30_CNT_N LABEL="当月逾期31-60天账户数"
		,T2.DUE_30_CNT AS DUE30_CNT_O LABEL="上月逾期31-60天账户数"
		,PUT((T1.DUE_30_CNT-T2.DUE_30_CNT)/T2.DUE_30_CNT,PERCENTN8.2) AS NADD_DUE30CNT LABEL="逾期账户环比增长率"
		,T1.DUE_30/10000 AS DUE30_AMT_N LABEL="当月逾期31-60天未归还贷款本金"
		,T2.DUE_30/10000 AS DUE30_AMT_O LABEL="上月逾期31-60天未归还贷款本金"
		,PUT((T1.DUE_30-T2.DUE_30)/T2.DUE_30,PERCENTN8.2) AS NADD_DUE30AMT LABEL="逾期金额环比增长率"
		,ROUND((T1.DUE_30/10000)/T1.DUE_30_CNT,0.01) AS AVG_DUE30AMT_N LABEL="当月平均逾期金额"
		,ROUND((T2.DUE_30/10000)/T2.DUE_30_CNT,0.01) AS AVG_DUE30AMT_O LABEL="上月平均逾期金额"
	FROM LOAN_OVERDUE_N AS T1
	LEFT JOIN LOAN_OVERDUE_O AS T2
	ON T1.SLOANTYPE=T2.SLOANTYPE;
QUIT;
 

PROC SQL NOPRINT;
	CREATE TABLE O04 AS SELECT
		PUT(T1.SLOANTYPE,$LOAN_LEVEL.) AS LOAN_TYPE  LABEL="贷款类型"
		,T1.DUE_60_CNT AS DUE60_CNT_N LABEL="当月逾期61-90天账户数"
		,T2.DUE_60_CNT AS DUE60_CNT_O LABEL="上月逾期61-90天账户数"
		,PUT((T1.DUE_60_CNT-T2.DUE_60_CNT)/T2.DUE_60_CNT,PERCENTN8.2) AS NADD_DUE60CNT LABEL="逾期账户环比增长率"
		,round(T1.DUE_60/10000,1) AS DUE60_AMT_N LABEL="当月逾期61-90天未归还贷款本金"
		,round(T2.DUE_60/10000,1) AS DUE60_AMT_O LABEL="上月逾期61-90天未归还贷款本金"
		,PUT((T1.DUE_60-T2.DUE_60)/T2.DUE_60,PERCENTN8.2) AS NADD_DUE60AMT LABEL="逾期金额环比增长率"
		,ROUND((T1.DUE_60/10000)/T1.DUE_60_CNT,0.01) AS AVG_DUE60AMT_N LABEL="当月平均逾期金额"
		,ROUND((T2.DUE_60/10000)/T2.DUE_60_CNT,0.01) AS AVG_DUE60AMT_O LABEL="上月平均逾期金额"
	FROM LOAN_OVERDUE_N AS T1
	LEFT JOIN LOAN_OVERDUE_O AS T2
	ON T1.SLOANTYPE=T2.SLOANTYPE;
QUIT;
 

PROC SQL NOPRINT;
	CREATE TABLE O05 AS SELECT
		PUT(T1.SLOANTYPE,$LOAN_LEVEL.) AS LOAN_TYPE  LABEL="贷款类型"
		,T1.DUE_90_CNT AS DUE90_CNT_N LABEL="当月逾期91-180天账户数"
		,T2.DUE_90_CNT AS DUE90_CNT_O LABEL="上月逾期91-180天账户数"
		,PUT((T1.DUE_90_CNT-T2.DUE_90_CNT)/T2.DUE_90_CNT,PERCENTN8.2) AS NADD_DUE90CNT LABEL="逾期账户环比增长率"
		,round(T1.DUE_90/10000,1) AS DUE90_AMT_N LABEL="当月逾期91-180天未归还贷款本金"
		,round(T2.DUE_90/10000,1) AS DUE90_AMT_O LABEL="上月逾期91-180天未归还贷款本金"
		,PUT((T1.DUE_90-T2.DUE_90)/T2.DUE_90,PERCENTN8.2) AS NADD_DUE90AMT LABEL="逾期金额环比增长率"
		,ROUND((T1.DUE_90/10000)/T1.DUE_90_CNT,0.01) AS AVG_DUE90AMT_N LABEL="当月平均逾期金额"
		,ROUND((T2.DUE_90/10000)/T2.DUE_90_CNT,0.01) AS AVG_DUE90AMT_O LABEL="上月平均逾期金额"
	FROM LOAN_OVERDUE_N AS T1
	LEFT JOIN LOAN_OVERDUE_O AS T2
	ON T1.SLOANTYPE=T2.SLOANTYPE;
QUIT;
 
PROC SQL NOPRINT;
	CREATE TABLE O06 AS SELECT
		PUT(T1.SLOANTYPE,$LOAN_LEVEL.) AS LOAN_TYPE  LABEL="贷款类型"
		,T1.DUE_180_CNT AS DUE180_CNT_N LABEL="当月逾期180天以上账户数"
		,T2.DUE_180_CNT AS DUE180_CNT_O LABEL="上月逾期180天以上账户数"
		,PUT((T1.DUE_180_CNT-T2.DUE_180_CNT)/T2.DUE_180_CNT,PERCENTN8.2) AS NADD_DUE180CNT LABEL="逾期账户环比增长率"
		,round(T1.DUE_180/10000,1) AS DUE180_AMT_N LABEL="当月逾期180天以上未归还贷款本金"
		,round(T2.DUE_180/10000,1) AS DUE180_AMT_O LABEL="上月逾期180天以上未归还贷款本金"
		,PUT((T1.DUE_180-T2.DUE_180)/T2.DUE_180,PERCENTN8.2) AS NADD_DUE180AMT LABEL="逾期金额环比增长率"
		,ROUND((T1.DUE_180/10000)/T1.DUE_180_CNT,0.01) AS AVG_DUE180AMT_N LABEL="当月平均逾期金额"
		,ROUND((T2.DUE_180/10000)/T2.DUE_180_CNT,0.01) AS AVG_DUE180AMT_O LABEL="上月平均逾期金额"
	FROM LOAN_OVERDUE_N AS T1
	LEFT JOIN LOAN_OVERDUE_O AS T2
	ON T1.SLOANTYPE=T2.SLOANTYPE;
QUIT;
/*按照时间段算逾期 ADD BY TIANYANQIN 2014.12.05
将逾期金额计算出来，需要自己算金额逾期率
该算法有些重复计算金额*/
/*生成O07逾期率*/
PROC SQL NOPRINT;
	CREATE TABLE O07_MONEY AS SELECT
		OPEN_DUR_CD,
		SUM(ICREDITLIMIT) AS ALL,
		SUM(iamountpastdue) AS DUE_ALL,
		SUM(iamountpastdue) - SUM(Iamountpastdue30) - SUM(Iamountpastdue60) - SUM(Iamountpastdue90) - SUM(Iamountpastdue180) AS DUE_1_30,
		SUM(Iamountpastdue30) AS DUE_31_60,
		SUM(Iamountpastdue60) AS DUE_61_90,
		SUM(Iamountpastdue90) AS DUE_91_180,
		SUM(Iamountpastdue180) AS DUE_180_
	FROM Sino_loan_n3
	GROUP BY OPEN_DUR_CD;
QUIT;

DATA O07;
	SET O07_MONEY;
		OVERDUE_ALL=PUT(DUE_ALL/ALL,percent8.2);
		OVERDUE_1_30=PUT(DUE_1_30/ALL,percent8.2);
		OVERDUE_31_60=PUT(DUE_31_60/ALL,percent8.2);
		OVERDUE_61_90=PUT(DUE_61_90/ALL,percent8.2);
		OVERDUE_91_180=PUT(DUE_91_180/ALL,percent8.2);
		OVERDUE_180_=PUT(DUE_180_/ALL,percent8.2);
		DROP ALL DUE_ALL  DUE_1_30 DUE_31_60 DUE_61_90 DUE_91_180  DUE_180_;
	LABEL
	OPEN_DUR_CD="发生业务期间"
		OVERDUE_ALL="逾期率"
OVERDUE_1_30="1-30天逾期率"
OVERDUE_31_60="31-60天逾期率"
OVERDUE_61_90="61-90天逾期率"
OVERDUE_91_180="91_180天逾期率"
OVERDUE_180_="180天以上逾期率"
;
run;

PROC SORT DATA=O07;
	by descending OPEN_DUR_CD;
RUN;
/*逾期账户数，不涉及到重复计算*/
/*PROC SQL NOPRINT;*/
/*	CREATE TABLE O07_BUSS AS SELECT*/
/*		OPEN_DUR_CD*/
/*		,SUM(CASE WHEN ICREDITLIMIT^=0  THEN 1 ELSE 0 END) AS ALL*/
/*		,SUM(CASE WHEN Iamountpastdue180^=0   THEN 1 ELSE 0 END) AS DUE_180_*/
/*		,SUM(CASE WHEN Iamountpastdue180=0 AND Iamountpastdue90^=0  THEN 1 ELSE 0 END ) AS DUE_91_180*/
/*		,SUM(CASE WHEN Iamountpastdue180=0 AND Iamountpastdue90=0 AND Iamountpastdue60^=0   THEN 1 ELSE 0 END) AS DUE_61_90*/
/*		,SUM(CASE WHEN Iamountpastdue180=0 AND Iamountpastdue90=0 AND Iamountpastdue60=0 AND  Iamountpastdue30^=0  THEN 1 ELSE 0 END) AS DUE_31_60*/
/*		,SUM(CASE WHEN Iamountpastdue180=0 AND Iamountpastdue90=0 AND Iamountpastdue60=0 AND  Iamountpastdue30=0 AND iamountpastdue^=0  THEN 1 ELSE 0 END) AS DUE_30*/
/*	FROM Sino_loan_n3*/
/*	GROUP BY OPEN_DUR_CD;*/
/*QUIT;*/

/*
%LET LAST_DT=INTNX('MONTH',&STAT_DT,-1,'END');
*/
/*STEP2 数据清洗，获取本月及上月数据*/
/*
PROC SORT DATA=SSS.SINO_LOAN(WHERE=(SUBSTR(SORGCODE,1,1)='Q' AND SORGCODE^='Q10152900H0000' AND DATEPART(DGETDATE)<=&STAT_DT.))  OUT=SINO_LOAN_N1;
	BY SORGCODE SACCOUNT DGETDATE;
RUN;
SUM(CASE WHEN SACCOUNT^=''  THEN 1 ELSE 0 END) AS LOAN_CNT

*/

/*输出中加入O07 李楠 2015-02-05*/
LIBNAME MYXLS EXCEL &OUTPATH_O01.;
DATA MYXLS."O01逾期情况表"n(dblabel=YES);
	SET O01;
RUN;
DATA MYXLS."O02逾期率"n(dblabel=YES);
	SET O02;
RUN;
DATA MYXLS."O03逾期31-60天"n(dblabel=YES);
	SET O03;
RUN;
DATA MYXLS."O04逾期61-90天"n(dblabel=YES);
	SET O04;
RUN;
DATA MYXLS."O05逾期91-180天"n(dblabel=YES);
	SET O05;
RUN;
DATA MYXLS."O06逾期180天以上"n(dblabel=YES);
	SET O06;
RUN;
DATA MYXLS."O07逾期率"n(dblabel=YES);
	SET O07;
RUN;
LIBNAME MYXLS CLEAR;

%MEND;
